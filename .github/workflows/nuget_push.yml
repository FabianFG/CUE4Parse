# yoinked from Marlon
name: NuGet Push

on:
  push:
    branches: [ master, dotnet-10 ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  OWNER: "FabianFG"

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: GIT Checkout
        uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Compute package version from Directory.Build.props
        id: ver
        shell: pwsh
        run: |
          $content = Get-Content .\Directory.Build.props -Raw -Encoding UTF8
          if (-not $content) { throw "Could not read Directory.Build.props" }
          
          # Parse <Version>1.2.2</Version> with regex (strips whitespace/tabs)
          if ($content -match '<Version>\s*([0-9]+\.[0-9]+\.[0-9]+)\s*</Version>') {
            $baseVersion = $matches[1]
          } else {
            throw "Could not parse 3-part SemVer <Version> from Directory.Build.props. Found: '$content'"
          }
          
          $version = "$baseVersion.$($env:GITHUB_RUN_NUMBER)"
          "packageVersion=$version" >> $env:GITHUB_OUTPUT
          Write-Host "PackageVersion=$version (parsed base: '$baseVersion' + run: $($env:GITHUB_RUN_NUMBER))"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Pack NuGet Package(s)
        run: >
          dotnet pack -c Release --no-restore --no-build `
            -p:Version=${{ steps.ver.outputs.packageVersion }} `
            -p:PackageVersion=${{ steps.ver.outputs.packageVersion }} `
            --output $env:USERPROFILE\nuget-packages

      - name: List packages
        run: dir $env:USERPROFILE\nuget-packages\*.nupkg

      - name: Add GitHub Packages source
        run: |
          dotnet nuget add source `
            --username ${{ github.actor }} `
            --password ${{ secrets.GITHUB_TOKEN }} `
            --store-password-in-clear-text `
            --name github `
            "https://nuget.pkg.github.com/${{ env.OWNER }}/index.json"

      - name: Push NuGet Package(s) to GitHub Packages
        run: |
          dotnet nuget push "$env:USERPROFILE\nuget-packages\*.nupkg" `
            --source github `
            --api-key ${{ secrets.GITHUB_TOKEN }} `
            --skip-duplicate
