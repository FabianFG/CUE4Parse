# yoinked from Marlon
name: NuGet Push

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  OWNER: "FabianFG"

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: GIT Checkout
        uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Compute package version from Directory.Build.props
        id: ver
        shell: pwsh
        run: |
          [xml]$props = Get-Content .\Directory.Build.props
          $baseVersion = $props.Project.PropertyGroup.Version
          if (-not $baseVersion) { 
            throw "Could not find <Version> in Directory.Build.props" 
          }
          $version = "$baseVersion.${{ github.run_number }}"
          "packageVersion=$version" >> $env:GITHUB_OUTPUT
          Write-Host "PackageVersion=$version (base: $baseVersion + run: ${{ github.run_number }})"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Pack NuGet Package(s)
        run: >
          dotnet pack -c Release --no-restore --no-build `
            -p:Version=${{ steps.ver.outputs.packageVersion }} `
            -p:PackageVersion=${{ steps.ver.outputs.packageVersion }} `
            --output $env:USERPROFILE\nuget-packages

      - name: List packages
        run: dir $env:USERPROFILE\nuget-packages\*.nupkg

      - name: Add GitHub Packages source
        run: |
          dotnet nuget add source `
            --username ${{ github.actor }} `
            --password ${{ secrets.GITHUB_TOKEN }} `
            --store-password-in-clear-text `
            --name github `
            "https://nuget.pkg.github.com/${{ env.OWNER }}/index.json"

      - name: Push NuGet Package(s) to GitHub Packages
        run: |
          dotnet nuget push "$env:USERPROFILE\nuget-packages\*.nupkg" `
            --source github `
            --api-key ${{ secrets.GITHUB_TOKEN }} `
            --skip-duplicate
