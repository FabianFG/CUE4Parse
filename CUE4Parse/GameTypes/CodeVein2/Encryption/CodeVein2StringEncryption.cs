using System;
using System.Text;
using CommunityToolkit.HighPerformance;
using CUE4Parse.UE4.Readers;

namespace CUE4Parse.GameTypes.CodeVein2.Encryption;

public enum ECV2DecryptionMode
{
    Locres,
    StringTable
}

public class CodeVein2StringEncryption
{
    private static readonly byte[] CodeVein2XorkeyLocres =
    [
        0xE9, 0x63, 0xCB, 0x28, 0xB6, 0xCD, 0x06, 0xCA, 0x5D, 0xBB, 0x57, 0xDB, 0xDC, 0x18, 0xDE, 0x2A,
        0x38, 0x30, 0x8C, 0x69, 0xBA, 0x9C, 0xB1, 0x7D, 0x70, 0x0C, 0x08, 0x93, 0x14, 0xE2, 0x25, 0x92,
        0x7B, 0xAF, 0x56, 0x88, 0x47, 0x61, 0x86, 0xC8, 0xF7, 0xEE, 0x1B, 0x4E, 0xCC, 0x45, 0x98, 0x4D,
        0xBC, 0xDD, 0x59, 0x84, 0x26, 0x5B, 0x0F, 0x22, 0x85, 0x77, 0x5A, 0x9A, 0x53, 0x1A, 0x83, 0x81
    ];
    private static readonly byte[] CodeVein2XorkeySTBL =
    [
        0x1D, 0x2E, 0xD7, 0xD5, 0x9E, 0x5F, 0x46, 0xDA, 0x57, 0xE7, 0xB8, 0x9B, 0x9F, 0x17, 0x60, 0x64,
        0x8D, 0x20, 0x81, 0x14, 0x2B, 0x5D, 0x97, 0x8B, 0x35, 0x27, 0x07, 0xFD, 0x65, 0xB5, 0x71, 0x4F,
        0x74, 0x01, 0xC3, 0x61, 0x5B, 0xBC, 0x66, 0x7E, 0x82, 0x91, 0xF9, 0x6C, 0x85, 0x51, 0xBA, 0x11,
        0x90, 0xFA, 0xD2, 0x62, 0xEB, 0xE3, 0x68, 0xC5, 0xC6, 0xBE, 0xBF, 0xB6, 0xDC, 0xDF, 0x5A, 0xF0
    ];

    public static string CodeVein2EncryptedFString(FArchive Ar, ECV2DecryptionMode mode)
    {
        var CodeVein2Xorkey = mode switch
        {
            ECV2DecryptionMode.Locres => CodeVein2XorkeyLocres,
            ECV2DecryptionMode.StringTable => CodeVein2XorkeySTBL,
            _ => CodeVein2XorkeyLocres,
        };
        var length = Ar.Read<int>();
        if (length > 0)
        {
            var str = Ar.ReadArray<byte>(length).AsSpan();
            length--;

            for (var c = 0; c < length; c++)
            {
                var xorChar = CodeVein2Xorkey[(length + c) & 0x3f];
                str[c] ^= xorChar;
            }
            return Encoding.UTF8.GetString(str[..^1]);
        }
        else if (length < 0)
        {
            length = -length;
            var str = Ar.ReadArray<char>(length).AsSpan();
            length--;

            for (var c = 0; c < length; c++)
            {
                var xorChar = (char) (CodeVein2Xorkey[(length + c) & 0x3f]);
                if (str[c] == 0xf000) str[c] = (char) 0x00;
                if (str[c] == 0xf001) str[c] = (char) 0xffff;
                str[c] ^= xorChar;
            }
            return Encoding.Unicode.GetString(str[..^1].AsBytes());
        }
        else
        {
            return "";
        }
    }
}
